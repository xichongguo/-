name: æ›´æ–°è¥¿å……å½±è§†TVBoxé…ç½®

on:
  workflow_dispatch:
  schedule:
    - cron: "0 23,9 * * *"

# âœ… å…³é”®ä¿®å¤ï¼šæ·»åŠ å†™å…¥æƒé™
permissions:
  contents: write  # å…è®¸æäº¤å’Œæ¨é€

jobs:
  update-config:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          # âœ… å…³é”®ä¿®å¤ï¼šä½¿ç”¨ä¸ªäºº Token æˆ–å¢å¼ºæƒé™
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: ä¸‹è½½å¹¶æ›´æ–°é…ç½®
        run: |
          python << 'EOF'
          import requests
          import json
          from datetime import datetime

          CONFIG_URL = "http://cdn.qiaoji8.com/tvbox.json"
          OUTPUT_FILE = "è¥¿å……å½±è§†.json"

          NEW_LIVE = {
              "name": "è¥¿ç“œç›´æ’­",
              "type": 3,
              "url": "https://raw.githubusercontent.com/xichongguo/live-stream/refs/heads/main/live/current.m3u8",
              "epg": "https://epg.zbds.top/",
              "logo": "",
              "categories": "å¤®è§†,å«è§†,ä½“è‚²,ç”µå½±,ç»¼è‰º,åœ°æ–¹"
          }

          try:
              res = requests.get(CONFIG_URL, headers={'User-Agent': 'TVBox-Updater'}, timeout=10)
              res.raise_for_status()
              data = res.json()
          except Exception as e:
              print(f"âŒ è·å–é…ç½®å¤±è´¥: {e}")
              exit(1)

          if 'lives' not in data:
              data['lives'] = []

          # æ·»åŠ ç›´æ’­æºï¼ˆé¿å…é‡å¤ï¼‰
          if not any(l.get('url') == NEW_LIVE['url'] for l in data['lives']):
              data['lives'].append(NEW_LIVE)
              print("âœ… å·²æ·»åŠ ç›´æ’­æº")

          # ç»Ÿä¸€è®¾ç½® EPG
          for live in data.get('lives', []):
              if 'epg' in live:
                  live['epg'] = "https://epg.zbds.top/"

          # ä¿®æ”¹ç¬¬ä¸€ä¸ªç«™ç‚¹åç§°
          if 'sites' in data and data['sites']:
              data['sites'][0]['name'] = "è¥¿å……å½±è§†"

          # æ›´æ–°å£çº¸æ—¶é—´
          if 'wallpaper' in data:
              data['wallpaper'] = f"è¥¿å……å½±è§† - {datetime.now().strftime('%m-%d %H:%M')}"

          # ä¿å­˜æ–‡ä»¶
          try:
              with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                  json.dump(data, f, ensure_ascii=False, indent=2)
              print(f"âœ… æˆåŠŸç”Ÿæˆ: {OUTPUT_FILE}")
          except Exception as e:
              print(f"âŒ ä¿å­˜å¤±è´¥: {e}")
              exit(1)
          EOF

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add è¥¿å……å½±è§†.json
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --name-only | grep -q "è¥¿å……å½±è§†.json"; then
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°: è¥¿å……å½±è§†.json"
            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "â¡ï¸ æ–‡ä»¶æœªå˜åŒ–ï¼Œè·³è¿‡æ¨é€"
          fi
