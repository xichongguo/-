name: Update TVBox Config

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7,19 * * *"  # ÊØèÂ§© 15:00 Âíå 03:00 UTC+8

permissions:
  contents: write

jobs:
  update-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install requests

      - name: Fetch and Update Config
        run: |
          python << 'EOF'
          import requests
          import json
          from datetime import datetime

          # === Ê∫êÈÖçÁΩÆÂú∞ÂùÄ ===
          SOURCE_URL = "http://cdn.qiaoji8.com/tvbox.json"

          # === ËæìÂá∫Êñá‰ª∂Âêç ===
          OUTPUT_FILE = "xichongyingshi.json"

          # === Ë¶ÅÊ∑ªÂä†ÁöÑÁõ¥Êí≠Ê∫ê ===
          NEW_LIVE = {
              "name": "xichongtv",
              "type": 0,
              "url": "https://raw.githubusercontent.com/xichongguo/live-stream/refs/heads/main/live/current.m3u8",
              "epg": "https://epg.zbds.top/",
              "categories": "Â§ÆËßÜ,Âç´ËßÜ,‰ΩìËÇ≤,ÁîµÂΩ±,ÁªºËâ∫,Âú∞Êñπ"
          }

          # Ëé∑ÂèñÈÖçÁΩÆ
          print("üîç ËØ∑Ê±ÇÈÖçÁΩÆÊ∫ê...")
          res = requests.get(SOURCE_URL, headers={'User-Agent': 'TVBox-Updater'})
          if res.status_code != 200:
              print(f"‚ùå HTTP ÈîôËØØ: {res.status_code}")
              exit(1)

          try:
              data = res.json()
              print("‚úÖ ÊàêÂäüËé∑ÂèñÈÖçÁΩÆ")
          except:
              print("‚ùå ÂìçÂ∫î‰∏çÊòØÊúâÊïàÁöÑ JSON")
              exit(1)

          # Âº∫Âà∂ËÆæÁΩÆÂΩ±ËßÜÁ´ô
          data['sites'] = [
              {
                  "key": "xichong",
                  "name": "Ë•øÂÖÖÂΩ±ËßÜ",
                  "type": 1,
                  "api": "http://cdn.qiaoji8.com/tvbox.php",
                  "searchable": 1,
                  "quickSearch": 1,
                  "filterable": 1
              }
          ]
          print("‚úÖ ÂΩ±ËßÜÁ´ôÂ∑≤ËÆæÁΩÆ")

          # Ê∏ÖÁ©∫ spider Èò≤Ê≠¢ TVBox Â¥©Ê∫É
          if 'spider' in data:
              data['spider'] = ""
              print("üîß spider Â≠óÊÆµÂ∑≤Ê∏ÖÁ©∫")

          # Á°Æ‰øù lives Â≠òÂú®
          if 'lives' not in data:
              data['lives'] = []
              print("üîß ÂàùÂßãÂåñ lives ÂàóË°®")

          # Ê∑ªÂä†Áõ¥Êí≠Ê∫êÔºàÈÅøÂÖçÈáçÂ§çÔºâ
          existing_urls = [l.get('url') for l in data['lives'] if 'url' in l]
          if NEW_LIVE['url'] not in existing_urls:
              data['lives'].append(NEW_LIVE)
              print("‚úÖ Áõ¥Êí≠Ê∫êÂ∑≤Ê∑ªÂä†: xichongtv")
          else:
              print("‚ÑπÔ∏è  Áõ¥Êí≠Ê∫êÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáÊ∑ªÂä†")

          # Áªü‰∏ÄËÆæÁΩÆ EPG
          for live in data.get('lives', []):
              if 'epg' in live:
                  live['epg'] = "https://epg.zbds.top/"

          # Êõ¥Êñ∞Â£ÅÁ∫∏ÔºàÊòæÁ§∫Êõ¥Êñ∞Êó∂Èó¥Ôºâ
          if 'wallpaper' in data:
              data['wallpaper'] = f"xichongyingshi - {datetime.now().strftime('%Y-%m-%d')}"

          # ‰øùÂ≠òÊñá‰ª∂
          try:
              with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                  json.dump(data, f, ensure_ascii=False, indent=2)
              print(f"‚úÖ ÈÖçÁΩÆÊñá‰ª∂Â∑≤ÁîüÊàê: {OUTPUT_FILE}")
          except Exception as e:
              print(f"‚ùå Êñá‰ª∂ÂÜôÂÖ•Â§±Ë¥•: {e}")
              exit(1)
          EOF

      # ================================
      # ‚úÖ Êèê‰∫§Âπ∂Êé®ÈÄÅÔºàÂÆâÂÖ®ÁâàÔºâ
      # ================================
      - name: Commit and Push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Êîπ
          if ! git diff --quiet; then
            echo "üìù Ê£ÄÊµãÂà∞Êõ¥ÊîπÔºåÂáÜÂ§áÊèê‰∫§"
            
            # Ê∑ªÂä†Êñá‰ª∂
            git add xichongyingshi.json
            
            # Êèê‰∫§
            git commit -m "üîÑ Update: xichongyingshi.json [$(date '+%Y%m%d%H%M%S')]"
            
            # Êé®ÈÄÅÔºà‰ΩøÁî®ÂÆâÂÖ®ÊñπÂºèÔºâ
            git push origin main || {
              echo "‚ö†Ô∏è Êé®ÈÄÅÂ§±Ë¥•ÔºåÂ∞ùËØïÂº∫Âà∂ÂêåÊ≠•"
              git fetch origin
              git reset --hard origin/main
              git add xichongyingshi.json
              git commit -m "üîÑ Force Update: xichongyingshi.json [$(date '+%Y%m%d%H%M%S')]" || echo "‚úÖ Êó†Êñ∞Êõ¥Êîπ"
              git push origin main
            }
            
            echo "‚úÖ Êõ¥Êñ∞ÊàêÂäüÔºÅ"
          else
            echo "‚úÖ Êó†Êõ¥ÊîπÔºåÊó†ÈúÄÊé®ÈÄÅ"
          fi
