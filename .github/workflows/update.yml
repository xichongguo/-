name: Update TVBox Config

on:
  workflow_dispatch:
  schedule:
    - cron: "0 23,9 * * *"  # æ¯å¤© 07:00 å’Œ 17:00 UTC+8

permissions:
  contents: write

jobs:
  update-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # ğŸ” å¿…é¡»å¼€å¯ï¼Œå¦åˆ™ git pull å¤±è´¥
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install requests

      - name: Fetch and Update Config
        run: |
          python << 'EOF'
          import requests
          import json
          from datetime import datetime

          # === æºé…ç½®åœ°å€ï¼ˆæ”¯æŒå¤šæº fallbackï¼‰===
          SOURCES = [
              "http://cdn.qiaoji8.com/tvbox.json",
              "https://raw.githubusercontent.com/xichongguo/tvbox-backup/main/tvbox.json"
          ]

          # === è¾“å‡ºæ–‡ä»¶å ===
          OUTPUT_FILE = "xichongyingshi.json"

          # === è¦æ·»åŠ çš„ç›´æ’­æº ===
          NEW_LIVE = {
              "name": "xichongtv",
              "type": 3,
              "url": "https://raw.githubusercontent.com/xichongguo/live-stream/refs/heads/main/live/current.m3u8",
              "epg": "https://epg.zbds.top/",
              "logo": "",
              "categories": "å¤®è§†,å«è§†,ä½“è‚²,ç”µå½±,ç»¼è‰º,åœ°æ–¹"
          }

          def fetch_from_sources():
              """å°è¯•ä»å¤šä¸ªæºè·å–é…ç½®"""
              for i, url in enumerate(SOURCES):
                  try:
                      print(f"ğŸ” [{i+1}/{len(SOURCES)}] è¯·æ±‚: {url}")
                      res = requests.get(
                          url,
                          headers={'User-Agent': 'TVBox-Updater'},
                          timeout=15,
                          verify=False  # å¿½ç•¥ SSL è¯ä¹¦é—®é¢˜ï¼ˆå…¼å®¹æ€§ï¼‰
                      )
                      print(f"   ğŸ’¡ çŠ¶æ€ç : {res.status_code}")
                      if res.status_code == 200:
                          text = res.text.strip()
                          if text.startswith(('{', '[')):
                              print(f"   âœ… å“åº”ä¸º JSONï¼Œé•¿åº¦: {len(text)}")
                              return json.loads(text), url
                          else:
                              print(f"   âŒ å“åº”ä¸æ˜¯ JSON: {text[:200]}")
                      else:
                          print(f"   âŒ HTTP é”™è¯¯: {res.status_code}")
                  except Exception as e:
                      print(f"   âŒ å¼‚å¸¸: {e}")
              return None, None

          # è·å–é…ç½®
          data, final_url = fetch_from_sources()
          if not data:
              print("ğŸ’€ æ‰€æœ‰æºå‡å¤±è´¥ï¼Œç»ˆæ­¢æ„å»º")
              exit(1)
          print(f"âœ… æˆåŠŸä» {final_url} è·å–é…ç½®")

          # å¼ºåˆ¶è®¾ç½®å½±è§†ç«™
          data['sites'] = [
              {
                  "key": "xichong",
                  "name": "è¥¿å……å½±è§†",
                  "type": 1,
                  "api": "http://cdn.qiaoji8.com/tvbox.php",
                  "searchable": 1,
                  "quickSearch": 1,
                  "filterable": 1
              }
          ]
          print("âœ… å½±è§†ç«™å·²è®¾ç½®")

          # æ¸…ç©º spider é˜²æ­¢ TVBox å´©æºƒ
          if 'spider' in data:
              data['spider'] = ""
              print("ğŸ”§ spider å­—æ®µå·²æ¸…ç©º")

          # ç¡®ä¿ lives å­˜åœ¨
          if 'lives' not in data:
              data['lives'] = []
              print("ğŸ”§ åˆå§‹åŒ– lives åˆ—è¡¨")

          # æ·»åŠ ç›´æ’­æºï¼ˆé¿å…é‡å¤ï¼‰
          if not any(l.get('url') == NEW_LIVE['url'] for l in data['lives']):
              data['lives'].append(NEW_LIVE)
              print("âœ… ç›´æ’­æºå·²æ·»åŠ : xichongtv")
          else:
              print("â„¹ï¸  ç›´æ’­æºå·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ")

          # ç»Ÿä¸€è®¾ç½® EPG
          for live in data.get('lives', []):
              if 'epg' in live:
                  live['epg'] = "https://epg.zbds.top/"

          # æ›´æ–°å£çº¸ï¼ˆæ˜¾ç¤ºæ›´æ–°æ—¶é—´ï¼‰
          if 'wallpaper' in data:
              data['wallpaper'] = f"xichongyingshi - {datetime.now().strftime('%m-%d %H:%M')}"

          # ä¿å­˜æ–‡ä»¶
          try:
              with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                  json.dump(data, f, ensure_ascii=False, indent=2)
              print(f"âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: {OUTPUT_FILE}")
          except Exception as e:
              print(f"âŒ æ–‡ä»¶å†™å…¥å¤±è´¥: {e}")
              exit(1)
          EOF

      # ================================
      # âœ… æäº¤å¹¶æ¨é€ï¼ˆé˜²å†²çªï¼‰
      # ================================
      - name: Commit and Push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          # æ·»åŠ æ–‡ä»¶
          git add xichongyingshi.json

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff-index --quiet HEAD --; then
            echo "ğŸŸ¡ æ— æ›´æ”¹ï¼Œæ— éœ€æäº¤"
            exit 0
          fi

          # æäº¤
          git commit -m "ğŸ”„ Update: xichongyingshi.json [$(date '+%Y%m%d%H%M%S')]"

          # ğŸ” å…ˆæ‹‰å–å†æ¨é€ï¼Œè§£å†³å¹¶å‘å†²çª
          echo "ğŸ” æ­£åœ¨æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main --rebase || {
            echo "âŒ æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆå¹¶å†²çª"
            exit 1
          }

          # æ¨é€
          echo "ğŸš€ æ­£åœ¨æ¨é€..."
          git push origin main

          echo "âœ… æ›´æ–°æˆåŠŸï¼"
