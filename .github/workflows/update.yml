name: 更新西充影视TVBox配置

on:
  workflow_dispatch:
  schedule:
    - cron: "0 23,9 * * *"

permissions:
  contents: write

jobs:
  update-config:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 安装依赖
        run: pip install requests

      - name: 下载并更新配置
        run: |
          python << 'EOF'
          import requests
          import json
          from datetime import datetime

          CONFIG_URL = "http://cdn.qiaoji8.com/tvbox.json"
          OUTPUT_FILE = "西充影视.json"

          NEW_LIVE = {
              "name": "西瓜直播",
              "type": 3,
              "url": "https://raw.githubusercontent.com/xichongguo/live-stream/refs/heads/main/live/current.m3u8",
              "epg": "https://epg.zbds.top/",
              "logo": "",
              "categories": "央视,卫视,体育,电影,综艺,地方"
          }

          try:
              res = requests.get(CONFIG_URL, headers={'User-Agent': 'TVBox-Updater'}, timeout=10)
              res.raise_for_status()
              data = res.json()
              print("✅ 成功获取远程配置")
          except Exception as e:
              print(f"❌ 获取配置失败: {e}")
              exit(1)

          # 调试：打印原始站点名
          if 'sites' in data and data['sites']:
              print(f"🔍 原始站点名: {data['sites'][0]['name']}")
          else:
              print("⚠️ 未找到 sites 字段")

          # 添加直播源
          if 'lives' not in data:
              data['lives'] = []
              print("🔧 初始化 lives 列表")

          if not any(l.get('url') == NEW_LIVE['url'] for l in data['lives']):
              data['lives'].append(NEW_LIVE)
              print("✅ 已添加直播源")

          # 设置 EPG
          for live in data.get('lives', []):
              if 'epg' in live:
                  live['epg'] = "https://epg.zbds.top/"

          # 修改站点名
          if 'sites' in data and data['sites']:
              data['sites'][0]['name'] = "西充影视"
              print("✅ 站点名称已改为: 西充影视")
          else:
              print("❌ 无法修改站点名：sites 不存在")

          # 更新壁纸
          if 'wallpaper' in data:
              data['wallpaper'] = f"西充影视 - {datetime.now().strftime('%m-%d %H:%M')}"

          # 保存文件
          try:
              with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                  json.dump(data, f, ensure_ascii=False, indent=2)
              print(f"✅ 文件已生成: {OUTPUT_FILE}")
          except Exception as e:
              print(f"❌ 保存文件失败: {e}")
              exit(1)
          EOF

      - name: 提交并推送
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add 西充影视.json
          git commit -m "🔄 自动更新: 西充影视.json [$(date '+%Y%m%d%H%M%S')]" --allow-empty
          git push
